<div class="row hidden-mobile">
    <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
        <h1 class="page-title txt-color-blueDark">
            <i class="fa-fw fa fa-picture-o"></i>
            ${m.asString("domain.gallery.title")}</h1>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">
        <div class="well">
            <blockquote>
                <div id="info" class="click2edit"></div>
            </blockquote>

            <div class="">
                <button id="edit_explain" class="btn btn-sm" type="button">${m.asString("buttons.info.edit")}</button>
                <button id="save_explain" class="btn btn-sm" type="button">${m.asString("buttons.info.save")}</button>
            </div>
        </div>
    </div>
</div>

<!-- row -->
<div class="row">
    <gallery class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="widget-body">
            <ul id="myTab1" class="nav nav-tabs bordered">
                <li class="active"><a href="#list" data-toggle="tab"><i class="fa fa-fw fa-lg fa-gear"></i> ${m.asString("domain.gallery.list")}</a></li>
                <li><a href="#query" data-toggle="tab"><i class="fa fa-fw fa-lg fa-gear"></i> ${m.asString("domain.gallery.query")}</a></li>
                <li><a href="#template" data-toggle="tab"><i class="fa fa-fw fa-lg fa-gear"></i> ${m.asString("domain.gallery.template")}</a></li>
            </ul>

            <div id="myContent1" class="tab-content padding-10">
                <div class="tab-pane fade in active" id="list">
                    <div class="jarviswidget jarviswidget-color-purple" id="gallery-list-win" data-widget-editbutton="false" data-widget-deletebutton="false">
                        <header>
                            <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                            <h2>${m.asString("domain.gallery.list.table-header")}</h2>
                        </header>

                        <div>
                            <div class="btn-group" style="margin-bottom: 10px">
                                <button type="button" class="btn btn-default view-list"><i class="fa fa-list"></i></button>
                                <button type="button" class="btn btn-default view-icon"><i class="fa fa-picture-o"></i></button>
                            </div>

                            <!-- SuperBox -->
                            <div id="table_list">
                                <table id="gallerys" class="table table-bordered table-hover" width="100%">
                                </table>
                            </div>
                            <div id="icon_list" style="display: none;">
                                <div class="superbox col-sm-12" id="superbox_body">

                                    <div class="superbox-float"></div>
                                </div>
                                <div class="superbox-show" style="height:300px; display: none"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="query">
                    <div class="jarviswidget jarviswidget-color-purple" id="gallery-query-win" data-widget-editbutton="false" data-widget-deletebutton="false">
                        <header>
                            <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                            <h2>${m.asString("domain.gallery.query.table-header")}</h2>
                        </header>
                        <div>
                            <div class="col-xs-5 col-sm-5 col-md-5 col-lg-5">
                                <form class="smart-form" id="gallery-query-form" method="post" action="gallery/query" novalidate="novalidate">
                                    <fieldset style="padding: 0px">
                                        <section>
                                            <label class="label">${m.asString("domain.gallery.query.query")}<a href="http://lucene.apache.org/core/2_9_4/queryparsersyntax.html" target="_blank"><span class="label pull-right">operator</span></a></label>
                                            <label class="textarea textarea-resizable">
                                                <textarea name="query" rows="3"></textarea>
                                            </label>
                                        </section>
                                        <section>
                                            <label class="label">${m.asString("domain.gallery.query.sort")}</label>
                                            <label class="input">
                                                <input type="text" name="sort"/>
                                            </label>
                                        </section>
                                        <div class="row">
                                            <section class="col col-6">
                                                <label class="label">${m.asString("domain.gallery.query.skip")}</label>
                                                <label class="input">
                                                    <input type="text" name="skip" placeholder="0" />
                                                </label>
                                            </section>
                                            <section class="col col-6">
                                                <label class="label">${m.asString("domain.gallery.query.offset")}</label>
                                                <label class="input">
                                                    <input type="text" name="offset" placeholder="10" />
                                                </label>
                                            </section>
                                        </div>
                                        <section>
                                            <label class="label">${m.asString("domain.gallery.query.query-parameter")}</label>
                                            <label class="input">
                                                <input type="text" name="parameter" placeholder="key1=val&key2=val2"/>
                                            </label>
                                        </section>
                                        <section>
                                            <label class="label">${m.asString("domain.gallery.query.document-type")}</label>
                                            <label class="select">
                                                <select name="rtype">
                                                    <option value="json">JSON</option>
                                                    <option value="csv">CSV</option>
                                                    <option value="xml">XML</option>
                                                    <option value="template">Template</option>
                                                </select>
                                            </label>
                                        </section>
                                        <section>
                                            <label class="checkbox"><input type="checkbox" name="indent" checked="false" /><i></i>${m.asString("domain.gallery.query.indent")}</label>
                                        </section>

                                    </fieldset>

                                    <footer>
                                        <button class="btn btn-primary" type="button" name="btn_exec">${m.asString("domain.gallery.query.buttons.execute")}</button>
                                    </footer>

                                    <div class="message">
                                        <i class="fa fa-thumbs-up"></i>
                                        <p>Your message was successfully sent!</p>
                                    </div>
                                </form>
                            </div>

                            <div class="col-xs-7 col-sm-7 col-md-7 col-lg-7">
                                <div class="alert alert-info alert-block" id="query-url"></div>
                                <div><pre id="query-result"></pre></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="template">
                    <div class="jarviswidget jarviswidget-color-purple" id="gallery-template-win" data-widget-editbutton="false" data-widget-deletebutton="false">
                        <header>
                            <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                            <h2>${m.asString("domain.gallery.template.table-header")}</h2>
                        </header>
                        <form class="smart-form" id="gallery-template-form" method="post" action="gallery/template" novalidate="novalidate">
                            <fieldset>
                                <section>
                                    <label class="select">
                                        <select name="template_samples"><option value=''>${m.asString("domain.gallery.template.view-sample")}</option></select>
                                    </label>
                                </section>

                                <section>
                                    <label class="label">${m.asString("domain.gallery.template.content")}</label>
                                    <label class="textarea textarea-resizable"><textarea name="template" rows="20"></textarea></label>
                                </section>
                            </fieldset>

                            <div id="save-message" class="alert alert-success fade in message">
                                <i class="fa-fw fa fa-check"></i>
                                <strong>Success</strong> <span></span>
                            </div>
                            <footer>
                                <button class="btn btn-success" type="button" name="btn_save"><i class="fa fa-check"></i> ${m.asString("domain.gallery.template.buttons.save")}</button>
                            </footer>
                        </form>
                    </div>
                </div>
            </div>



        </div>
    </gallery>
    <!-- /SuperBox -->



</div>

<!-- end row -->

<script type="text/javascript">

    pageSetUp();

    var superBoxInitized = false;

    var pagefunction = function() {

        $('.view-icon').click(function() {
            if(!superBoxInitized) {
                $('.superbox').SuperBox();
                superBoxInitized = true ;
            }
            $('#table_list').hide();
            $('#icon_list').show();
        });

        $('.view-list').click(function() {
            $('#icon_list').hide();
            $('#table_list').show();
        });

        $( "#edit_explain" ).click(function() {
            $('.click2edit').summernote({
                focus : true, toolbar: [
                    //['style', ['style']], // no style button
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    //['insert', ['picture', 'link']], // no insert buttons
                    ['table', ['table']], // no table button
                    // ['help', ['help']] //no help button
                ]
            });
        });

        $( "#save_explain" ).click(function() {
            var aHTML = $('.click2edit').code() ;
            $.ajax({
                type: "POST",
                url: "/admin/menus/domain",
                data: { content: aHTML, field: "gallery" }
            });
            $('.click2edit').destroy();
        });

        var domainId = $("#domains option:selected").val() ;
        if (domainId == undefined) return ;

        $.ajax({
            url:'/admin/menus/domain?field=gallery',
            dataType:'text',
            success:function(data){
                $("#info").html(data) ;
            },
            error:function(request,status,error){
                console.log('response', request, status, error) ;
            }
        }) ;

        $.ajax({
            type: 'GET',
            url: '/admin/gallery/' + domainId + '/list',
            dataType: 'json',
            success: function(data) {
                var nodes = data['result'] ;

                var table = $('#gallerys').DataTable({
                    'data': nodes,
                     searching:false,
                     order: [[0, 'desc']],
                    'columns': [
                        {'title':'galid'},
                        {'title':'catid'},
                        {'title':'subject'},
                        {'title':'width'},
                        {'title':'height'},
                        {'title':'filesize'},
                        {'title':'modday'}
                    ]
                });
                var tableFoot = '<tfoot><tr><td colspan="7" class="col-xs-12">' +
				'				<fieldset class="smart-form">' +
				'					<div class="row">' +
				'						<section class="col col-9"></section>' +
				'						<section class="col col-3"><label class="input"><input type="text" name="searchQuery" placeholder="Search Query"></label></section>' +
				'					</div>' +
				'				</fieldset>' +
				'				</td></tr></tfoot>' ;

				$(tableFoot).appendTo($("#gallerys")) ;

				var gallerys = $("#gallerys") ;
				var _searchQuery = gallerys.find("input[name=searchQuery]") ;
				_searchQuery.on('keypress', function (event) {
					if(event.which == '13'){
						$.ajax({
							type:'GET',
							url:"/admin/gallery/" + domainId + "/list",
							dataType:'json',
							data : {'query':_searchQuery.val()},
							success:function(data){
								table.clear() ;
								table.destroy() ;

								var nodes = data['result'] ;
								table = $('#gallerys').DataTable({
					                    'data': nodes,
					                     searching:false,
					                     order: [[0, 'desc']],
					                    'columns': [
					                        {'title':'galid'},
					                        {'title':'catid'},
					                        {'title':'subject'},
					                        {'title':'width'},
					                        {'title':'height'},
					                        {'title':'filesize'},
					                        {'title':'modday'}
					                    ]
					                });

								gallerys = $('#gallerys') ;
				                $("#gallerys tbody tr").each(function() {
				                   	var galId = $(this).find("td").eq(0).text() ;
				                   	var url = "/admin/gallery/" + domainId + "/view/" + galId ;
				                   	$(this).find("td").eq(0).html("<a data-lightbox='groupphoto' href=" + url + ">" + galId + "</a>")
				                });
							},
							error:function(request,status,error){
								console.log('response', request, status, error) ;
							}
						});

					}
				});


                jQuery("#gallerys tbody tr").each(function() {
                   	var galId = $(this).find("td").eq(0).text() ;
                   	var url = "/admin/gallery/" + domainId + "/view/" + galId ;
                   	$(this).find("td").eq(0).html("<a data-lightbox='groupphoto' href=" + url + ">" + galId + "</a>")
                });

                var superbox = $('#superbox_body') ;
                $.each(nodes, function(index) {
                    var gallery = nodes[index], galId = gallery[0], catId = gallery[1], fileName = gallery[2], type = fileName.substr(fileName.lastIndexOf('.') + 1) ;
                    var turl = '/admin/gallery/' + domainId + '/resize/' + galId + '?width=137&height=137';
                    var rurl = '/admin/gallery/' + domainId + '/view/' + galId ;
                    var el = '<div class="superbox-list"><img class="superbox-img" src="' + turl + '" data-img="' + rurl + '" title="'+fileName+'"></div>' ;
                    $(el).appendTo(superbox) ;
                });
            }
        });

        var _queryForm = $("#gallery-query-form") ;
        var _rtype = _queryForm.find("select[name=rtype]") ;
        var _parameter = _queryForm.find("input[name=parameter]") ;
        var _query = _queryForm.find("textarea[name=query]") ;
        var _sort = _queryForm.find("input[name=sort]") ;
        var _skip = _queryForm.find("input[name=skip]") ;
        var _offset = _queryForm.find("input[name=offset]") ;
        var _indent = _queryForm.find("input[name=indent]") ;
        var _debug = _queryForm.find("input[name=debug]") ;
        var _btn_exec = _queryForm.find("button[name=btn_exec]") ;

        _btn_exec.click(function() {
            $.ajax({
                type: "GET",
                dataType : 'text',
                url: "/admin/gallery/" + domainId + "/query." + _rtype.val() + (  _parameter.val() ? "?" + _parameter.val() : ""),
                data: { query: _query.val(), sort: _sort.val(), skip: _skip.val(), offset: _offset.val() , indent: _indent.is(":checked") ? true : false, debug: _debug.is(":checked") ? true : false},
                complete : function(){
                    var targetURL = "<a href='http://" + document.location.host +  this.url + "' target='_blank'>" + this.url + "</a>";
                    $("#query-url").html(targetURL) ;
                },
                success :  function(data) {
                    $("#query-result").text(data) ;
                }
            }) ;
        });

        var _templateForm = $("#gallery-template-form") ;
        var _template = _templateForm.find("textarea[name=template]") ;
        var _template_samples = _templateForm.find("select[name=template_samples]") ;
        var _btn_save = _templateForm.find("button[name=btn_save]") ;

        $.ajax({
            url:'/admin/gallery/' + domainId +'/template',
            dataType:'json',
            success:function(data){
                var samples = data['samples'];
                var template = data['template'] ;

                for(var idx in samples ){
                    var sample = samples[idx] ;
                    var option = $('<option value="'+sample+'">'+sample+'</option>') ;
                    option.appendTo(_template_samples) ;
                }

                _template.val(template);
            },
            error:function(request,status,error){
                console.log('response', request, status, error) ;
            }
        }) ;

        _template_samples.change(function(){
            var fileName = _template_samples.val() ;
            if (fileName < ' ') return ;
            $.ajax({
                type: "GET",
                dataType : 'text',
                url: "/admin/gallery/" + domainId + "/samples/" + fileName,
                data: {},
                complete : function(){
                },
                success :  function(data) {
                    _template.val(data) ;
                }
            }) ;
        }) ;

        _templateForm.validate({
            rules : {
                template : { required : true }
            },

            messages : {
                template : { required : "${m.asString('validation.required', 'template content')}"}
            },

            submitHandler : function(form) {
                $.ajax({
                            type: "POST",
                            url: "/admin/gallery/" + domainId + "/template",
                            data: { template: _template.val() },
                            success :  function(data) {
                                $("#save-message span").html(data) ;
                                $("#save-message").removeClass("message") ;
                                setTimeout(function() {
                                    $("#save-message").addClass("message") ;
                                }, 2000);
                            }}
                ).done(function( msg ) {
                        });
            },

            errorPlacement : function(error, element) { // Do not change code below
                error.insertAfter(element.parent());
            }
        });

        _btn_save.click(function() {
            command = 'save' ;
            _templateForm.submit() ;
        });

        // crop part
        var image = $('#galleryImg'), jcrop_api ;

        $('#gallery-crop-modal').on('shown.bs.modal', function(event) {
            var current = $('.superbox-current-img') ;
            var originalWidth = current[0].naturalWidth, originalHeight = current[0].naturalHeight ;

            image.Jcrop({
                trueSize: [originalWidth, originalHeight],
                boxWidth: 750
            }, function() {
                jcrop_api = this ;
            });
        }).on('hidden.bs.modal', function(event) {
            jcrop_api.destroy() ;
            image.css('width', '').css('height', '');
        });

        $('#gallery-crop-modal button[name=crop]').click(function(event) {
            var galId = image.attr('galid'), domainId = image.attr('did') ;
            var area = jcrop_api.tellSelect() ;
            var x = area.x, y = area.y, width = area.x2 - area.x, height = area.y2 - area.y ;

            if(width == 0 || height == 0) {
                $.bigBox({
                    title : "Crop error",
                    content : "Crop area not selected",
                    color : "#C46A69",
                    icon : "fa fa-warning shake animated",
                    timeout : 2000
                });

                return ;
            }

            var url = '/admin/gallery/' + domainId + '/crop/' + galId + '?x=' + x + '&y=' + y + '&width=' + width + '&height=' + height ;
            $.ajax({
                type: "GET",
                url: url,
                data: { },
                success :  function(data) {
                    $("#save-message span").html(data) ;
                    $("#save-message").removeClass("message") ;
                    setTimeout(function() {
                        $("#save-message").addClass("message") ;
                    }, 2000);
                }}
            ).done(function( msg ) {
                $.bigBox({
                    title : "Success",
                    content : "Cropped successfully",
                    color : "#739E73",
                    icon : "fa fa-check",
                    timeout : 2000
                });
            });
        });

        $('#gallery-crop-modal button[name=reset]').click(function(event) {
            if(jcrop_api) {
                jcrop_api.release() ;
                jcrop_api.setSelect([0, 0, 0, 0]) ;
            }
        });
    };

    var cropHandler = function(event) {
        var _data = event.data, image = $('#galleryImg');

        image.attr('src', _data.src) ;
        image.attr('data-width', _data.originalWidth) ;
        image.attr('data-height', _data.originalHeight) ;
        image.attr('galid', _data.basic.galid) ;
        image.attr('catid', _data.basic.catid) ;
        image.attr('did', _data.basic.domainid) ;

        $('#gallery-crop-modal').modal();
    }

    loadScript("js/plugin/datatables/jquery.dataTables.min.js", function(){
        loadScript("js/plugin/datatables/dataTables.bootstrap.min.js", function() {
            loadScript("js/plugin/summernote/summernote.min.js", function() {
                loadScript("js/plugin/superbox/superbox.min.custom.js", function() {
                    loadScript("js/plugin/jcrop/jquery.jcrop.js", pagefunction) ;
                });
            });
        });
    });

</script>

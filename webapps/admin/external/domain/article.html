<div class="row">
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
        <h1 class="page-title txt-color-blueDark">
            <i class="fa fa-edit fa-fw "></i>${m.asString("domain.article.title")}
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-sm-12">
        <div class="well">
            <blockquote>
                <div id="info" class="click2edit"></div>
            </blockquote>

            <div class="">
                <button id="edit_explain" class="btn btn-sm" type="button">${m.asString("buttons.info.edit")}</button>
                <button id="save_explain" class="btn btn-sm" type="button">${m.asString("buttons.info.save")}</button>
            </div>
        </div>
    </div>
</div>


<section id="widget-grid" class="">
    <div class="row">
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

                <div>
                    <div class="jarviswidget-editbox"></div>
                    <div class="widget-body">

                        <ul id="myTab1" class="nav nav-tabs bordered">
                            <li class="active"><a href="#list" data-toggle="tab"><i class="fa fa-fw fa-lg fa-gear"></i> ${m.asString("domain.article.list")}</a></li>
                            <li><a href="#query" data-toggle="tab"><i class="fa fa-fw fa-lg fa-gear"></i> ${m.asString("domain.article.query")}</a></li>
                            <li><a href="#template" data-toggle="tab"><i class="fa fa-fw fa-lg fa-gear"></i> ${m.asString("domain.article.template")}</a></li>
                        </ul>

                        <div id="myContent1" class="tab-content padding-10">
                            <div class="tab-pane fade in active" id="list">
                                <div class="jarviswidget jarviswidget-color-purple" id="article-list-win" data-widget-editbutton="false" data-widget-deletebutton="false">
                                    <header>
                                        <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                                        <h2>${m.asString("domain.article.list.table-header")}</h2>
                                    </header>
                                    <div>
                                        <table id="articles" class="table table-bordered table-hover" width="100%">
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="query">
                                <div class="jarviswidget jarviswidget-color-purple" id="article-query-win" data-widget-editbutton="false" data-widget-deletebutton="false">
                                    <header>
                                        <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                                        <h2>${m.asString("domain.article.query.table-header")}</h2>
                                    </header>
                                    <div>
                                        <div class="col-xs-5 col-sm-5 col-md-5 col-lg-5">
                                            <form class="smart-form" id="article-query-form" method="post" action="article/query" novalidate="novalidate">
                                                <fieldset style="padding: 0px">
                                                    <section>
                                                        <label class="label">${m.asString("domain.article.query.query")}<a href="http://lucene.apache.org/core/2_9_4/queryparsersyntax.html" target="_blank"><span class="label pull-right">operator</span></a></label>
                                                        <label class="textarea textarea-resizable">
                                                            <textarea name="query" rows="3"></textarea>
                                                        </label>
                                                    </section>
                                                    <section>
                                                        <label class="label">${m.asString("domain.article.query.sort")}</label>
                                                        <label class="input">
                                                            <input type="text" name="sort"/>
                                                        </label>
                                                    </section>
                                                    <div class="row">
                                                        <section class="col col-6">
                                                            <label class="label">${m.asString("domain.article.query.skip")}</label>
                                                            <label class="input">
                                                                <input type="text" name="skip" placeholder="0" />
                                                            </label>
                                                        </section>
                                                        <section class="col col-6">
                                                            <label class="label">${m.asString("domain.article.query.offset")}</label>
                                                            <label class="input">
                                                                <input type="text" name="offset" placeholder="10" />
                                                            </label>
                                                        </section>
                                                    </div>
                                                    <section>
                                                        <label class="label">${m.asString("domain.article.query.query-parameter")}</label>
                                                        <label class="input">
                                                            <input type="text" name="parameter" placeholder="key1=val&key2=val2"/>
                                                        </label>
                                                    </section>
                                                    <section>
                                                        <label class="label">${m.asString("domain.article.query.document-type")}</label>
                                                        <label class="select">
                                                            <select name="rtype">
                                                                <option value="json">JSON</option>
                                                                <option value="csv">CSV</option>
                                                                <option value="xml">XML</option>
                                                                <option value="template">Template</option>
                                                            </select>
                                                        </label>
                                                    </section>
                                                    <section>
                                                        <label class="checkbox"><input type="checkbox" name="indent" checked="false" /><i></i>${m.asString("domain.article.query.indent")}</label>
                                                    </section>

                                                </fieldset>

                                                <footer>
                                                    <button class="btn btn-primary" type="button" name="btn_exec">${m.asString("domain.article.query.buttons.execute")}</button>
                                                </footer>

                                                <div class="message">
                                                    <i class="fa fa-thumbs-up"></i>
                                                    <p>Your message was successfully sent!</p>
                                                </div>
                                            </form>
                                        </div>

                                        <div class="col-xs-7 col-sm-7 col-md-7 col-lg-7">
                                            <div class="alert alert-info alert-block" id="query-url"></div>
                                            <div><pre id="query-result"></pre></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="template">
                                <div class="jarviswidget jarviswidget-color-purple" id="article-template-win" data-widget-editbutton="false" data-widget-deletebutton="false">
                                    <header>
                                        <span class="widget-icon"> <i class="fa fa-table"></i> </span>
                                        <h2>${m.asString("domain.article.template.table-header")}</h2>
                                    </header>
                                    <form class="smart-form" id="article-template-form" method="post" action="article/template" novalidate="novalidate">
                                        <fieldset>
                                            <section>
                                                <label class="select">
                                                    <select name="template_samples"><option value=''>${m.asString("domain.article.template.view-sample")}</option></select>
                                                </label>
                                            </section>

                                            <section>
                                                <label class="label">${m.asString("domain.article.template.content")}</label>
                                                <label class="textarea textarea-resizable"><textarea name="template" rows="20"></textarea></label>
                                            </section>
                                        </fieldset>

                                        <div id="save-message" class="alert alert-success fade in message">
                                            <i class="fa-fw fa fa-check"></i>
                                            <strong>Success</strong> <span></span>
                                        </div>
                                        <footer>
                                            <button class="btn btn-success" type="button" name="btn_save"><i class="fa fa-check"></i> ${m.asString("domain.article.template.buttons.save")}</button>
                                        </footer>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <!--</div>-->
        </article>
    </div>
</section>

<script type="text/javascript">

    pageSetUp();

    // pagefunction
    var pagefunction = function() {

        $( "#edit_explain" ).click(function() {
            $('.click2edit').summernote({
                focus : true, toolbar: [
                    //['style', ['style']], // no style button
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    //['insert', ['picture', 'link']], // no insert buttons
                    ['table', ['table']], // no table button
                    // ['help', ['help']] //no help button
                ]
            });
        });

        $( "#save_explain" ).click(function() {
            var aHTML = $('.click2edit').code() ;
            $.ajax({
                type: "POST",
                url: "/admin/menus/domain",
                data: { content: aHTML, field: "article" }
            });
            $('.click2edit').destroy();
        });

        var domainId = $("#domains option:selected").val() ;
        if (domainId == undefined) return ;

        $.ajax({
            url:'/admin/menus/domain?field=article',
            dataType:'text',
            success:function(data){
                $("#info").html(data) ;
            },
            error:function(request,status,error){
                console.log('response', request, status, error) ;
            }
        }) ;

        var articleData = function(table, trElement) {
            var values = table.row(trElement).data();
            return {
                artid: values[0],
                catid: values[1],
                subject: values[2],
                modday: values[3]
            };
        }

        $.ajax({
            type: 'GET',
            url: '/admin/article/' + domainId + '/list',
            dataType: 'json',
            success: function(data) {
                var nodes = data['result'] ;
                var table = $('#articles').DataTable({
                    data: nodes,
                    order: [[3, 'desc']],
                    columnDefs: [{
                        targets: '_all',
                        orderable: false
                    }],
                    'columns': [
                        {'title':'artid'},
                        {'title':'catid'},
                        {'title':'subject'},
                        {'title':'modday'},
                        {
                            data: '',
                            defaultContent: '<button>link</button>'
                        }
                    ]
                });

                $('#articles tbody').on('click', 'button', function(event) {
                    event.preventDefault();

                    var artData = articleData(table, $(this).parents('tr')) ;
                    $.ajax({
                        type: 'GET',
                        url: '/admin/article/' + domainId + '/storypage/' + artData.catid + '/' + artData.artid,
                        dataType: 'json',
                        success: function(data) {
                            var tbody = $('#story-pages tbody');
                            tbody.children('tr').remove();
                            var nodes = data['nodes'] ;
                            for(var i in nodes) {
                                var node = nodes[i];
                                var el = '<tr><td>'+node['tplid']+'</td><td>'+node['name']+'</td><td>'+node['form']+'</td><td>'+node['link']+'</td></tr>' ;

                                $(el).appendTo(tbody) ;
                            }
                            $('#story-pages-modal').modal({});
                        }
                    });

                    event.stopPropagation();
                });

                $('#articles tbody').on('click', 'tr', function (event) {
                    event.preventDefault();
                    var artData = articleData(table, $(this)) ;
                    $.ajax({
                        type: 'GET',
                        url: '/admin/article/' + domainId + '/view/' + artData.catid + '/' + artData.artid,
                        dataType: 'json',
                        success: function(data) {
                            var modal = $('#article-view-modal') ;
                            modal.find('span[title=artid]').text(data.std_info.artid);
                            modal.find('span[title=subject]').text(data.std_info.subject);
                            modal.find('div[title=content]').html(data.std_info.content);

                            modal.find('span[title=keyword]').text(data.add_info.keyword);

                            modal.find('span[title=operday]').text(data.set_info.operday);
                            modal.find('span[title=expireday]').text(data.set_info.expireday);
                            modal.find('span[title=gorulloc]').text(data.set_info.gorulloc);
                            modal.find('span[title=priority]').text(data.set_info.priority);

                            var thumbPath = data.add_info.thumbimg ;
                            if(thumbPath) {
                                var thumbArea = modal.find('span[title=thumbnail]');
                                var url = '/admin/article/' + domainId + thumbPath;
                                thumbArea.text(thumbPath);
                                thumbArea.parent().append('<a data-lightbox="' + thumbPath +'" href="' + url + '"><img src="' + url + '" width="137" height="137"></a>') ;
                            }

                            var tbody = $('#afield-table tbody') ;
                            tbody.empty() ;
                            for(var afieldid in data.afields){
                                var avalue = data.afields[afieldid] ;
                                var ameta = data['afield.' + afieldid] ;

                                if(avalue === 'null') avalue = '[EMPTY]' ;

                                if(ameta.typecd === 'File' && ameta.stringvalue !== 'null') {
                                    avalue += '<br><a href="/admin/article/' + domainId + '/' + ameta.streamvalue + '">Download</a>' ;
                                } else if(ameta.typecd === 'Image' && ameta.stringvalue !== 'null') {
                                    var url = '/admin/article/' + domainId + '/' + ameta.streamvalue ;
                                    avalue += '<br><a data-lightbox="' + ameta.stringvalue + '" href="' + url + '"><img src="' + url + '" width="137" height="137"></a>' ;
                                }

                                tbody.append('<tr><td>' + afieldid + '</td><td>' + avalue + '</td></tr>') ;
            				}
                            $('#article-view-modal').modal({});
                        }
                    });

                    event.stopPropagation() ;
                });
            }
        });

        var _queryForm = $("#article-query-form") ;
        var _rtype = _queryForm.find("select[name=rtype]") ;
        var _parameter = _queryForm.find("input[name=parameter]") ;
        var _query = _queryForm.find("textarea[name=query]") ;
        var _sort = _queryForm.find("input[name=sort]") ;
        var _skip = _queryForm.find("input[name=skip]") ;
        var _offset = _queryForm.find("input[name=offset]") ;
        var _indent = _queryForm.find("input[name=indent]") ;
        var _debug = _queryForm.find("input[name=debug]") ;
        var _btn_exec = _queryForm.find("button[name=btn_exec]") ;

        _btn_exec.click(function() {
            console.log('here') ;
            $.ajax({
                type: "GET",
                dataType : 'text',
                url: "/admin/article/" + domainId + "/query." + _rtype.val() + (  _parameter.val() ? "?" + _parameter.val() : ""),
                data: { query: _query.val(), sort: _sort.val(), skip: _skip.val(), offset: _offset.val() , indent: _indent.is(":checked") ? true : false, debug: _debug.is(":checked") ? true : false},
                complete : function(){
                    var targetURL = "<a href='http://" + document.location.host +  this.url + "' target='_blank'>" + this.url + "</a>";
                    $("#query-url").html(targetURL) ;
                },
                success :  function(data) {
                    $("#query-result").text(data) ;
                }
            }) ;
        });

        var _templateForm = $("#article-template-form") ;
        var _template = _templateForm.find("textarea[name=template]") ;
        var _template_samples = _templateForm.find("select[name=template_samples]") ;
        var _btn_save = _templateForm.find("button[name=btn_save]") ;

        $.ajax({
            url:'/admin/article/' + domainId +'/template',
            dataType:'json',
            success:function(data){
                var info = data['info'];
                var samples = data['samples'];
                var template = data['template'] ;

                for(var idx in samples ){
                    var sample = samples[idx] ;
                    var option = $('<option value="'+sample+'">'+sample+'</option>') ;
                    option.appendTo(_template_samples) ;
                }

                _template.val(template);
            },
            error:function(request,status,error){
                console.log('response', request, status, error) ;
            }
        }) ;

        _template_samples.change(function(){
            var fileName = _template_samples.val() ;
            if (fileName < ' ') return ;
            $.ajax({
                type: "GET",
                dataType : 'text',
                url: "/admin/article/" + domainId + "/samples/" + fileName,
                data: {},
                complete : function(){
                },
                success :  function(data) {
                    _template.val(data) ;
                }
            }) ;
        }) ;

        _templateForm.validate({
            rules : {
                template : { required : true }
            },

            messages : {
                template : { required : "${m.asString('validation.required', 'template content')}"}
            },

            submitHandler : function(form) {
                $.ajax({
                            type: "POST",
                            url: "/admin/article/" + domainId + "/template",
                            data: { template: _template.val() },
                            success :  function(data) {
                                $("#save-message span").html(data) ;
                                $("#save-message").removeClass("message") ;
                                setTimeout(function() {
                                    $("#save-message").addClass("message") ;
                                }, 2000);
                            }}
                ).done(function( msg ) {
                        });
            },

            errorPlacement : function(error, element) { // Do not change code below
                error.insertAfter(element.parent());
            }
        });

        _btn_save.click(function() {
            command = 'save' ;
            _templateForm.submit() ;
        });
    };

    var showStoryPages = function(event, _catId, _artId) {
        $('#story-pages-modal').modal({catId: _catId, artId: _artId});
        event.stopPropagation() ;
    }

    loadScript("js/plugin/datatables/jquery.dataTables.min.js", function(){
        loadScript("js/plugin/datatables/dataTables.bootstrap.min.js", function() {
            loadScript("js/plugin/summernote/summernote.min.js", function() {
                loadScript("js/plugin/lightbox/lightbox.js", pagefunction) ;
            });
        });
    });


</script>